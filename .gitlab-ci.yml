workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH

stages:
  - lint
  - build
  - package
  - deploy

.base-cargo:
  variables:
    CARGO_HOME: $CI_PROJECT_DIR/.cargo
  cache:
    key: $CI_PROJECT_NAME
    paths:
      - $CI_PROJECT_DIR/target/
      - $CI_PROJECT_DIR/.cargo/

lint:
  extends: .base-cargo
  stage: lint
  image: registry.ulbricht.casa/docker-images/arch-linux-plasma-build:latest
  script:
    - cargo clippy --release

build:
  extends: .base-cargo
  stage: build
  image: registry.ulbricht.casa/docker-images/arch-linux-plasma-build:latest
  script:
    - cargo build --release
    - cp target/release/jewels jewels
  artifacts:
    paths:
      - jewels

makepkg-arch:
  stage: package
  image: registry.ulbricht.casa/docker-images/arch-linux-plasma-build:latest
  variables:
    ARCH: amd64
    UC_PACKAGED_FILE: jewels-$CI_COMMIT_TAG-$REL-x86_64.pkg.tar.zst
    UC_TAG: $CI_COMMIT_TAG
    REL: 1
  script:
    - cp $CI_PROJECT_DIR/PKGBUILD $HOME
    - cp $CI_PROJECT_DIR/jewels $HOME
    - cp $CI_PROJECT_DIR/sc-apps-jewels.svg $HOME
    - cp $CI_PROJECT_DIR/dev.imanuel.jewels.desktop $HOME
    - cp $CI_PROJECT_DIR/dev.imanuel.jewels.autostart.desktop $HOME
    - makepkg
    - git clone https://$UC_BOT_USERNAME:$UC_ARCH_TOKEN@gitlab.imanuel.dev/packages/arch.git
    - cp $HOME/$UC_PACKAGED_FILE $HOME/arch/$UC_PACKAGED_FILE
    - cd arch
    - git config user.email $UC_BOT_EMAIL
    - git config user.name "Jewels"
    - git add .
    - git commit -m "Add new satellite version"
    - git push https://$UC_BOT_USERNAME:$UC_ARCH_TOKEN@gitlab.imanuel.dev/packages/arch.git main -o ci.skip
  artifacts:
    paths:
      - jewels-${CI_COMMIT_TAG:-1.0.0}-${CI_PIPELINE_IID}-x86_64.pkg.tar.zst

deploy-arch-package:
  stage: deploy
  extends:
    - .arch-linux
  dependencies:
    - makepkg-arch
  script:
    - git clone "https://ci:${CI_GIT_TOKEN}@gitlab.imanuel.dev/packages/arch.git"
    - cp jewels-${CI_COMMIT_TAG}-${CI_PIPELINE_IID}-x86_64.pkg.tar.zst arch/
    - cd arch
    - git switch -c jewels-${CI_COMMIT_TAG}-${CI_PIPELINE_IID}
    - repo-add ulbricht.db.tar.gz jewels-${CI_COMMIT_TAG}-${CI_PIPELINE_IID}-x86_64.pkg.tar.zst
    - git config --global user.email "jewels@ulbricht.cloud"
    - git config --global user.name "Jewly"
    - git commit -am "Added version ${CI_COMMIT_TAG}-${CI_PIPELINE_IID}"
    - git push -o merge_request.create -o merge_request.target=main -o merge_request.merge_when_pipeline_succeeds origin jewels-${CI_COMMIT_TAG}-${CI_PIPELINE_IID}
  rules:
    - if: $CI_COMMIT_TAG
      when: always
    - when: never